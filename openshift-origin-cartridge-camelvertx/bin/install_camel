#!/bin/bash -eu

version=6.0

echo "$version" > "$OPENSHIFT_CAMELVERTX_DIR/env/OPENSHIFT_CAMELVERTX_VERSION"

ln -s ${OPENSHIFT_CAMELVERTX_DIR}/standalone/log ${OPENSHIFT_CAMELVERTX_DIR}/logs

cp -r ${OPENSHIFT_CAMELVERTX_DIR}/versions/${version}/template/camel/* ${OPENSHIFT_CAMELVERTX_DIR}/template
cp -r ${OPENSHIFT_CAMELVERTX_DIR}/versions/${version}/template/camel/.openshift ${OPENSHIFT_CAMELVERTX_DIR}/template
cp ${OPENSHIFT_CAMELVERTX_DIR}/standalone/configuration/standalone.xml ${OPENSHIFT_CAMELVERTX_DIR}/template/.openshift/config
sed -i "s/{APP_NAME}/${OPENSHIFT_APP_NAME}/g" ${OPENSHIFT_CAMELVERTX_DIR}/template/camel/pom.xml

JBOSS_HOME=/etc/alternatives/camelvertx-$version

pushd $OPENSHIFT_CAMELVERTX_DIR > /dev/null
  ln -s ${JBOSS_HOME}/jboss-modules.jar
  ln -s ${JBOSS_HOME}/modules
popd > /dev/null

pushd $OPENSHIFT_CAMELVERTX_DIR/template/camel
  sed -i -e "s/\${env.OPENSHIFT_CAMELVERTX_IP}/${OPENSHIFT_CAMELVERTX_IP}/g" ./src/main/resources/cluster.xml
  mvn clean package -Popenshift -DskipTests
  cp deployments/ROOT.war $OPENSHIFT_CAMELVERTX_DIR/standalone/deployments
popd

JAVA_HOME=/etc/alternatives/java_sdk_1.7.0
M2_HOME=/etc/alternatives/maven-3.0
echo "$JAVA_HOME" > $OPENSHIFT_CAMELVERTX_DIR/env/JAVA_HOME
echo "$M2_HOME" > $OPENSHIFT_CAMELVERTX_DIR/env/M2_HOME
echo "$JAVA_HOME/bin:$M2_HOME/bin:$PATH" > $OPENSHIFT_CAMELVERTX_DIR/env/PATH